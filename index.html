<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=LXGW+WenKai+TC&display=swap" rel="stylesheet">
    <meta charset="UTF-8" />
    <title>我的待辦事項系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
      body { font-family: 'LXGW WenKai TC', sans-serif; }
      .todo-item:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.10); transform: translateY(-2px) scale(1.01); transition: all 0.2s; }
      .priority-1 { color: #d32f2f; font-weight: bold; }
      .priority-2 { color: #fbc02d; font-weight: bold; }
      .priority-3 { color: #388e3c; font-weight: bold; }
      .empty-tip { color: #aaa; text-align: center; margin: 16px 0; }
      .fade-in { animation: fadeIn 0.5s; }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
  </head>
  <body class="lxgw-wenkai-tc-regular min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-100 to-yellow-100 p-4">
    <div class="main_box mt-10 mx-auto w-full max-w-md bg-white rounded-2xl p-8 shadow-2xl flex flex-col items-center fade-in">
      <h1 class="text-center text-4xl font-extrabold mb-2 text-blue-700 flex items-center gap-2"><i class="fa-solid fa-list-check"></i> 代辦事項</h1>
      <hr class="w-full border-blue-200 my-4">
      <div class="add_todo flex flex-col items-center gap-4 w-full">
        <form action="POST" class="flex flex-col items-center gap-4 w-full" autocomplete="off">
          <div class="w-full">
            <label class="block text-lg mb-0.5 text-gray-700">名稱 <span class="text-red-500">*</span></label>
            <input type="text" name="named" placeholder="請輸入名稱" required maxlength="30" class="w-full border-none bg-blue-50 rounded-lg py-2 px-4 text-base focus:outline-none focus:bg-blue-100 focus:shadow-md transition duration-200 ease-in-out hover:bg-blue-100">
          </div>
          <div class="w-full flex gap-2">
            <div class="flex-1">
              <label class="block text-lg mb-0.5 text-gray-700">狀態</label>
              <select name="state" class="w-full border-none bg-blue-50 rounded-lg py-2 px-4 text-base focus:outline-none focus:bg-blue-100 focus:shadow-md transition duration-200 ease-in-out hover:bg-blue-100">
                <option value="true">已完成</option>
                <option value="false">未完成</option>
              </select>
            </div>
            <div class="flex-1">
              <label class="block text-lg mb-0.5 text-gray-700">優先度</label>
              <select name="priority" class="w-full border-none bg-blue-50 rounded-lg py-2 px-4 text-base focus:outline-none focus:bg-blue-100 focus:shadow-md transition duration-200 ease-in-out hover:bg-blue-100">
                <option value="1">高</option>
                <option value="2">中</option>
                <option value="3">低</option>
              </select>
            </div>
          </div>
          <div class="w-full">
            <label class="block text-lg mb-0.5 text-gray-700">備註</label>
            <input type="text" placeholder="無者可留空" maxlength="50" class="w-full border-none bg-blue-50 rounded-lg py-2 px-4 text-base focus:outline-none focus:bg-blue-100 focus:shadow-md transition duration-200 ease-in-out hover:bg-blue-100">
          </div>
          <div class="w-full flex gap-2">
            <button type="submit" class="flex-1 border-none rounded-lg py-2 px-6 bg-blue-500 text-white text-lg font-bold cursor-pointer mt-2 shadow-md hover:bg-blue-600 hover:shadow-lg transition duration-200 ease-in-out flex items-center justify-center"><i class="fa-solid fa-paper-plane mr-2"></i> <span id="submit-text">送出</span></button>
            <button type="button" id="clear-btn" class="flex-1 border-none rounded-lg py-2 px-6 bg-gray-200 text-gray-700 text-lg font-bold cursor-pointer mt-2 shadow-md hover:bg-gray-300 hover:shadow-lg transition duration-200 ease-in-out flex items-center justify-center"><i class="fa-solid fa-eraser mr-2"></i> 清空</button>
          </div>
        </form>
        <div class="w-full flex flex-wrap gap-2 mt-2">
          <input id="search-input" type="text" placeholder="搜尋名稱/備註..." class="flex-1 min-w-[0] border border-blue-200 rounded-lg py-2 px-4 text-base focus:outline-none focus:border-blue-400 transition duration-200">
          <button id="sort-btn" class="flex-shrink-0 border-none rounded-lg py-2 px-4 bg-yellow-400 text-white font-bold shadow-md hover:bg-yellow-500 transition duration-200 flex items-center whitespace-nowrap"><i class="fa-solid fa-sort"></i> 排序</button>
        </div>
      </div>
      <hr class="w-full border-blue-200 my-4">
      <div class="show_case w-full mt-6 flex flex-col items-center">
        <div name="done" class="w-full bg-blue-50 rounded-xl p-4 shadow-md mb-4">
          <h3 class="text-center text-xl font-semibold text-blue-700 mb-3 flex items-center gap-2"><i class="fa-solid fa-circle-check"></i> 已完成事項</h3>
          <div id="done-list"></div>
        </div>
        <div name="undone" class="w-full bg-yellow-50 rounded-xl p-4 shadow-md mb-4">
          <h3 class="text-center text-xl font-semibold text-orange-600 mb-3 flex items-center gap-2"><i class="fa-solid fa-circle-exclamation"></i> 未完成事項</h3>
          <div id="undone-list"></div>
        </div>
      </div>
    </div>
    <script>
const apiBase = 'https://camp-2025-backend-1012970328647.asia-east1.run.app';
const doneList = document.getElementById('done-list');
const undoneList = document.getElementById('undone-list');
const form = document.querySelector('.add_todo form');
const searchInput = document.getElementById('search-input');
const sortBtn = document.getElementById('sort-btn');
const clearBtn = document.getElementById('clear-btn');
const submitText = document.getElementById('submit-text');

let editingId = null;
let todosCache = [];
let sortAsc = true;

function renderTodos(todos) {
  doneList.innerHTML = '';
  undoneList.innerHTML = '';
  let doneCount = 0, undoneCount = 0;
  todos.forEach((todo, idx) => {
    const itemDiv = document.createElement('div');
    itemDiv.className = 'todo-item flex justify-between items-center my-2 py-2 px-3 rounded-lg shadow-sm bg-white';
    itemDiv.classList.add('fade-in');
    if (todo.priority == 1) itemDiv.classList.add('priority-1');
    if (todo.priority == 2) itemDiv.classList.add('priority-2');
    if (todo.priority == 3) itemDiv.classList.add('priority-3');
    itemDiv.style.background = todo.completed ? '#e0f7fa' : '#fffbe0';
    itemDiv.innerHTML = `
      <div class="flex flex-col">
        <b class="text-lg">${todo.title}</b>
        <small class="text-gray-500">${todo.description ? todo.description : ''}</small>
        <small class="block mt-1">優先度: <span class="priority-${todo.priority}">${['高','中','低'][todo.priority-1]}</span></small>
      </div>
      <div class="flex gap-2">
        <button class="edit-btn bg-green-100 hover:bg-green-200 text-green-700 rounded px-3 py-1 font-bold shadow" title="編輯" data-id="${idx}"><i class="fa-solid fa-pen"></i></button>
        <button class="delete-btn bg-red-100 hover:bg-red-200 text-red-700 rounded px-3 py-1 font-bold shadow" title="刪除" data-id="${idx}"><i class="fa-solid fa-trash"></i></button>
      </div>
    `;
    itemDiv.querySelector('.edit-btn').onclick = () => startEdit(idx, todo);
    itemDiv.querySelector('.delete-btn').onclick = () => deleteTodo(idx);
    if (todo.completed) {
      doneList.appendChild(itemDiv);
      doneCount++;
    } else {
      undoneList.appendChild(itemDiv);
      undoneCount++;
    }
  });
  if (doneCount === 0) doneList.innerHTML = '<div class="empty-tip"><i class="fa-regular fa-face-smile"></i> 沒有已完成事項</div>';
  if (undoneCount === 0) undoneList.innerHTML = '<div class="empty-tip"><i class="fa-regular fa-face-meh"></i> 沒有未完成事項</div>';
}

function fetchTodos(showLoading = true) {
  if (showLoading) {
    doneList.innerHTML = '<div class="empty-tip">載入中...</div>';
    undoneList.innerHTML = '<div class="empty-tip">載入中...</div>';
  }
  fetch(apiBase + '/todos')
    .then(r => r.json())
    .then(todos => {
      todosCache = todos;
      renderTodos(filterAndSortTodos());
    });
}

function filterAndSortTodos() {
  let filtered = todosCache;
  const q = searchInput.value.trim().toLowerCase();
  if (q) {
    filtered = filtered.filter(todo =>
      todo.title.toLowerCase().includes(q) ||
      (todo.description && todo.description.toLowerCase().includes(q))
    );
  }
  filtered = filtered.slice().sort((a, b) => sortAsc ? a.priority - b.priority : b.priority - a.priority);
  return filtered;
}

form.onsubmit = function(e) {
  e.preventDefault();
  const title = form.named.value.trim();
  const completed = form.state.value === 'true';
  const description = form.querySelector('input[placeholder="無者可留空"]').value.trim();
  const priority = parseInt(form.priority.value, 10);

  if (!title) {
    alert('請輸入名稱');
    return;
  }
  if (isNaN(priority) || priority < 1) {
      alert('優先度必須是正整數');
      return;
  }

  const todo = {
    title,
    description,
    completed,
    priority
  };
  submitText.textContent = '處理中...';
  if (editingId !== null) {
    fetch(apiBase + '/todo/' + editingId, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(todo)
    }).then(r => {
      if (!r.ok) throw new Error('更新失敗');
      return r.json();
    }).then(() => {
      editingId = null;
      form.reset();
      submitText.textContent = '送出';
      fetchTodos();
    }).catch(() => { alert('更新失敗'); submitText.textContent = '送出'; });
  } else {
    fetch(apiBase + '/todos', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(todo)
    }).then(r => {
      if (!r.ok) throw new Error('新增失敗');
      return r.json();
    }).then(() => {
      form.reset();
      submitText.textContent = '送出';
      fetchTodos();
    }).catch(() => { alert('新增失敗'); submitText.textContent = '送出'; });
  }
};

function startEdit(idx, todo) {
  form.named.value = todo.title;
  form.state.value = todo.completed ? 'true' : 'false';
  form.querySelector('input[placeholder="無者可留空"]').value = todo.description;
  form.priority.value = todo.priority;
  editingId = idx;
  submitText.textContent = '更新';
  form.named.focus();
}

function deleteTodo(idx) {
    if (confirm('確定要刪除此待辦事項嗎？')) {
        fetch(apiBase + '/todo/' + idx, {
            method: 'DELETE'
        }).then(function(r) {
            if (!r.ok) throw new Error('刪除失敗');
            fetchTodos();
        }).catch(function() { alert('刪除失敗'); });
    }
}

searchInput.addEventListener('input', () => renderTodos(filterAndSortTodos()));
sortBtn.addEventListener('click', () => {
  sortAsc = !sortAsc;
  sortBtn.innerHTML = `<i class="fa-solid fa-sort"></i> ${sortAsc ? '排序(高→低)' : '排序(低→高)'}`;
  renderTodos(filterAndSortTodos());
});
clearBtn.addEventListener('click', () => {
  if (confirm('確定要清空所有欄位？')) form.reset();
  editingId = null;
  submitText.textContent = '送出';
});

fetchTodos();
    </script>
  </body>
</html>
